{% extends 'base.html' %}
{% load static %}

{% block title %}{{ chapter_title }} - {{ subject.title }} - 介護福祉士試験対策{% endblock %}

{% block extra_head %}
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #fafafa;
            color: #333;
            line-height: 1.7;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header with breadcrumbs */
        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }

        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .breadcrumb-item {
            color: #666;
            text-decoration: none;
            font-size: 14px;
        }

        .breadcrumb-item:hover {
            color: {{ subject.color }};
        }

        .breadcrumb-item.active {
            color: #333;
            font-weight: 500;
        }

        .breadcrumb-separator {
            color: #ccc;
            font-size: 12px;
        }

        .chapter-header {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .chapter-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: {{ subject.color }};
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .chapter-info h1 {
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .chapter-info p {
            color: #666;
            font-size: 0.9rem;
        }

        /* Content area */
        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 24px;
        }

        .main-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .content-header {
            background: linear-gradient(135deg, {{ subject.color }} 0%, {{ subject.color }}dd 100%);
            color: white;
            padding: 20px;
        }

        .content-header h2 {
            font-size: 1.3rem;
            font-weight: 400;
        }

        .content-body {
            padding: 24px;
        }

        .content-body h3 {
            color: {{ subject.color }};
            margin-bottom: 16px;
            font-size: 1.2rem;
        }

        .content-body h4 {
            color: #333;
            margin: 20px 0 12px 0;
            font-size: 1.1rem;
        }

        .content-body p {
            margin-bottom: 16px;
            text-align: justify;
        }

        .content-body ul, .content-body ol {
            margin: 16px 0 16px 24px;
        }

        .content-body li {
            margin-bottom: 8px;
        }

        .practice-question {
            background: #f8f9fa;
            border-left: 4px solid {{ subject.color }};
            padding: 20px;
            margin: 24px 0;
            border-radius: 0 8px 8px 0;
        }

        .practice-question h4 {
            color: {{ subject.color }};
            margin-bottom: 12px;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }

        .choices label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .choices label:hover {
            background: #e3f2fd;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .sidebar-header {
            background: {{ subject.color }};
            color: white;
            padding: 16px;
            font-weight: 500;
        }

        .sidebar-content {
            padding: 16px;
        }

        .vocabulary-item {
            display: flex;
            flex-direction: column;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .vocabulary-item:last-child {
            border-bottom: none;
        }

        .vocab-word {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .vocab-reading {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 2px;
        }

        .vocab-translation {
            font-size: 0.9rem;
            color: {{ subject.color }};
        }

        .progress-section {
            text-align: center;
        }

        .progress-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient({{ subject.color }} 60%, #e0e0e0 60%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            position: relative;
        }

        .progress-circle::before {
            content: '';
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            position: absolute;
        }

        .progress-text {
            position: relative;
            font-weight: 600;
            color: {{ subject.color }};
        }

        .navigation-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .nav-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .nav-btn.primary {
            background: {{ subject.color }};
            color: white;
        }

        .nav-btn.secondary {
            background: #f5f5f5;
            color: #666;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        @media (max-width: 768px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: -1;
            }

            .navigation-buttons {
                flex-direction: column;
            }
        }

        /* Interactive text block styles */
        .text-block {
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }

        .japanese-text-container {
            line-height: 2.2;
            font-size: 1.1rem;
        }

        .indonesian-text-wrapper {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            margin-left: 0.5rem;
            margin-right: 4rem;
        }

        .indonesian-text-wrapper.open {
            max-height: 300px;
        }

        .indonesian-text {
            color: #4b5563;
            font-size: 0.95rem;
            padding: 0.75rem;
            background-color: #f9fafb;
            border-left: 3px solid #d1d5db;
        }

        .translation-toggle {
            background: none;
            border: none;
            color: #6b7280;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .translation-toggle:hover {
            background-color: #f3f4f6;
        }

        .translation-toggle i {
            transition: all 0.3s ease;
        }

        .translation-toggle.open i {
            transform: rotate(180deg);
        }

        .text-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
        }

        /* Vocabulary word styling */
        .vocabulary-word {
            cursor: pointer;
            border-bottom: 1px dotted #9ca3af;
            transition: border-color 0.2s;
        }

        .vocabulary-word:hover {
            border-color: #374151;
        }

        #translation-popup {
            max-width: 250px;
            line-height: 1.5;
            position: absolute;
            z-index: 50;
            padding: 12px;
            background-color: #1f2937;
            color: white;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            font-size: 0.875rem;
            display: none;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="breadcrumbs">
                <a href="{% url 'dashboard' %}" class="breadcrumb-item">ダッシュボード</a>
                <span class="breadcrumb-separator">›</span>
                <a href="{% url 'subject_learning' %}" class="breadcrumb-item">科目学習</a>
                <span class="breadcrumb-separator">›</span>
                <a href="{% url 'subject_detail' subject_name %}" class="breadcrumb-item">{{ subject.title }}</a>
                <span class="breadcrumb-separator">›</span>
                <span class="breadcrumb-item active">{{ chapter }}</span>
            </div>

            <div class="chapter-header">
                <div class="chapter-icon">
                    <span class="material-icons">{{ subject.icon }}</span>
                </div>
                <div class="chapter-info">
                    <h1>{{ chapter }}: {{ chapter_title }}</h1>
                    <p>{{ subject.description }}</p>
                </div>
            </div>
        </div>

        <!-- Content wrapper -->
        <div class="content-wrapper">
            <!-- Main content -->
            <div class="main-content">
                <div class="content-header">
                    <h2>{{ chapter_data.title }}</h2>
                </div>
                <div class="content-body">
                    <h2>{{ chapter_data.title }}</h2>

                    <!-- Text blocks from CSV -->
                    {% for text in chapter_data.texts %}
                    <div class="text-block">
                        <div class="text-container">
                            <p class="japanese-text-container" style="flex-grow: 1; padding-right: 1rem;">
                                {{ text.japanese|safe }}
                            </p>
                            <button class="translation-toggle" title="全文翻訳">
                                <i class="fa-solid fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="indonesian-text-wrapper">
                            <p class="indonesian-text">
                                {{ text.indonesian }}
                            </p>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Quiz Section -->
                    {% if chapter_data.questions %}
                    <div class="quiz-section" style="margin-top: 40px; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                        <h3 style="color: #007bff; margin-bottom: 20px;">📝 確認問題</h3>

                        {% for question in chapter_data.questions %}
                        <div class="quiz-question" style="margin-bottom: 30px; padding: 20px; background: white; border-radius: 6px; border-left: 4px solid #007bff;">
                            <h4 style="color: #333; margin-bottom: 15px;">問題{{ question.number }}</h4>
                            <p style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px;">
                                {{ question.japanese }}
                            </p>
                            <p style="font-size: 0.9rem; color: #666; margin-bottom: 20px; font-style: italic;">
                                {{ question.indonesian }}
                            </p>
                            <div class="quiz-options">
                                {% for option in question.options %}
                                <div class="option {% if option.is_correct %}correct-answer{% endif %}"
                                     style="margin-bottom: 10px; padding: 12px; border: 1px solid #dee2e6; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;"
                                     data-question="{{ question.number }}" data-option="{{ option.number }}">
                                    <label style="cursor: pointer; width: 100%; display: block;">
                                        <input type="radio" name="question{{ question.number }}" value="{{ option.number }}" style="margin-right: 10px;">
                                        {{ option.number }}. {{ option.japanese }}
                                        <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">{{ option.indonesian }}</div>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            <button class="check-answer-btn" onclick="checkAnswer({{ question.number }})"
                                    style="margin-top: 15px; padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                答えを確認
                            </button>
                            <div class="feedback" id="feedback{{ question.number }}" style="margin-top: 15px; padding: 15px; border-radius: 4px; display: none;"></div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Progress -->
                <div class="sidebar-section">
                    <div class="sidebar-header">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">trending_up</span>
                        学習進捗
                    </div>
                    <div class="sidebar-content progress-section">
                        <div class="progress-circle">
                            <div class="progress-text">60%</div>
                        </div>
                        <p>{{ chapter }}の学習進捗</p>
                    </div>
                </div>

                <!-- Vocabulary -->
                {% if chapter_data.vocabulary %}
                <div class="sidebar-section">
                    <div class="sidebar-header">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">translate</span>
                        重要語彙
                    </div>
                    <div class="sidebar-content">
                        {% for word, data in chapter_data.vocabulary.items %}
                        <div class="vocabulary-item">
                            <div class="vocab-word">{{ word }}</div>
                            <div class="vocab-reading">{{ data.reading }}</div>
                            <div class="vocab-translation">{{ data.translation }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Navigation -->
                <div class="sidebar-section">
                    <div class="sidebar-header">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">navigation</span>
                        ナビゲーション
                    </div>
                    <div class="sidebar-content">
                        <div class="navigation-buttons">
                            <button class="nav-btn secondary" onclick="goToPreviousChapter()">
                                <span class="material-icons">chevron_left</span>
                                前の章
                            </button>
                            <button class="nav-btn primary" onclick="goToNextChapter()">
                                次の章
                                <span class="material-icons">chevron_right</span>
                            </button>
                        </div>
                        <div class="navigation-buttons" style="margin-top: 12px;">
                            <button class="nav-btn secondary" onclick="goToSubjectDetail()">
                                <span class="material-icons">list</span>
                                章一覧
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Translation popup -->
    <div id="translation-popup"></div>

    <script>
        // Get translation popup element
        const translationPopup = document.getElementById('translation-popup');

        // Toggle functionality for translation buttons
        function handleToggle(e, toggleClass, wrapperClass) {
            const toggleBtn = e.target.closest(toggleClass);
            if (toggleBtn) {
                e.stopPropagation();
                toggleBtn.classList.toggle('open');
                const parent = toggleBtn.closest('.text-block');
                if (parent) {
                    const wrapper = parent.querySelector(wrapperClass);
                    if (wrapper) wrapper.classList.toggle('open');
                }
            }
        }

        // Add event listeners for translation toggles
        document.body.addEventListener('click', (e) => {
            const wordSpan = e.target.closest('.vocabulary-word');

            // Handle vocabulary word clicks
            if (wordSpan) {
                // Don't close popup if clicking on the popup itself
                if (e.target.closest('#translation-popup')) return;

                // Toggle popup if same word clicked again
                if (translationPopup.style.display === 'block' && translationPopup.dataset.owner === wordSpan.outerHTML) {
                    translationPopup.style.display = 'none';
                    return;
                }

                // Show translation popup
                const translation = wordSpan.dataset.translation;
                translationPopup.innerHTML = translation;
                translationPopup.dataset.owner = wordSpan.outerHTML;

                // Position popup
                const rect = wordSpan.getBoundingClientRect();
                translationPopup.style.display = 'block';
                const popupRect = translationPopup.getBoundingClientRect();

                let top = window.scrollY + rect.bottom + 8;
                let left = window.scrollX + rect.left + (rect.width / 2) - (popupRect.width / 2);

                // Adjust if popup goes off screen
                if (top + popupRect.height > window.innerHeight + window.scrollY) {
                    top = window.scrollY + rect.top - popupRect.height - 8;
                }
                if (left < 0) left = 10;
                else if (left + popupRect.width > window.innerWidth) left = window.innerWidth - popupRect.width - 10;

                translationPopup.style.top = `${top}px`;
                translationPopup.style.left = `${left}px`;

                e.stopPropagation();
            }
            // Handle translation toggle buttons
            else if (!e.target.closest('.translation-toggle')) {
                // Hide popup when clicking elsewhere
                translationPopup.style.display = 'none';
            }

            // Handle translation toggles
            handleToggle(e, '.translation-toggle', '.indonesian-text-wrapper');
        });

        // Quiz functionality
        const feedbackData = {{ chapter_data.feedback|safe }};

        function checkAnswer(questionNumber) {
            const selectedOption = document.querySelector(`input[name="question${questionNumber}"]:checked`);
            const feedbackDiv = document.getElementById(`feedback${questionNumber}`);

            if (!selectedOption) {
                alert('選択肢を選んでください。');
                return;
            }

            const selectedValue = parseInt(selectedOption.value);
            const feedback = feedbackData[questionNumber]?.[selectedValue];
            const correctOption = document.querySelector(`.quiz-question [data-question="${questionNumber}"] .correct-answer`);
            const isCorrect = selectedOption.closest('.option').classList.contains('correct-answer');

            // Show feedback
            feedbackDiv.style.display = 'block';
            feedbackDiv.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <span style="font-weight: bold; color: ${isCorrect ? '#28a745' : '#dc3545'};">
                        ${isCorrect ? '✓ 正解' : '✗ 不正解'}
                    </span>
                </div>
                <div style="background-color: #f8f9fa; padding: 12px; border-radius: 4px; border-left: 3px solid ${isCorrect ? '#28a745' : '#dc3545'};">
                    <strong>解説:</strong><br>
                    ${feedback?.japanese || ''}
                </div>
                <div style="background-color: #f1f3f4; padding: 12px; border-radius: 4px; margin-top: 10px; border-left: 3px solid #6c757d;">
                    <strong>インドネシア語:</strong><br>
                    ${feedback?.indonesian || ''}
                </div>
            `;

            // Highlight correct answer if user got it right
            if (isCorrect && correctOption) {
                correctOption.style.backgroundColor = '#d4edda';
                correctOption.style.borderColor = '#28a745';
            }
        }

        function goToPreviousChapter() {
            alert('前の章の機能は準備中です');
        }

        function goToNextChapter() {
            alert('次の章の機能は準備中です');
        }

        function goToSubjectDetail() {
            window.location.href = '{% url "subject_detail" subject_name %}';
        }

        console.log('Chapter learning page loaded: {{ subject_name }} - {{ chapter }}');
    </script>
{% endblock %}